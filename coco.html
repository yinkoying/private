require 'erb'

module SvgFlow
  class Generator
    # ----------------------------------------------------------------
    # 初始化設定
    # ----------------------------------------------------------------
    def initialize(title:, subtitle: "", steps: [], theme_color: "#4b5563")
      @title = title
      @subtitle = subtitle
      @steps = steps
      @theme_color = theme_color
      
      # 版面參數
      @card_height = 80
      @gap = 40
      @step_height = @card_height + @gap
      @start_y = 10
    end

    # ----------------------------------------------------------------
    # 執行渲染
    # ----------------------------------------------------------------
    def render
      # 自動計算 SVG 畫布總高度
      @svg_height = (@steps.count * @step_height) + 50
      
      # 載入並執行 ERB 樣板
      template = ERB.new(get_template)
      template.result(binding)
    end

    private

    # ----------------------------------------------------------------
    # HTML/SVG 樣板核心
    # ----------------------------------------------------------------
    def get_template
      <<~HTML
        <!DOCTYPE html>
        <html lang="zh-TW">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title><%= @title %></title>
            <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
            <style>
                /* 全域設定 */
                body { background-color: #f0fdf4; font-family: 'Noto Sans TC', sans-serif; display: flex; justify-content: center; padding: 40px 20px; }
                .paper-sheet { background: white; width: 100%; max-width: 800px; padding: 40px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); border-radius: 12px; }
                
                /* 標題區塊 */
                h1 { font-size: 24px; color: #1e293b; text-align: center; margin-bottom: 5px; font-weight: 700; letter-spacing: 0.05em; }
                p.subtitle { text-align: center; color: <%= @theme_color %>; font-size: 14px; margin-bottom: 40px; font-weight: 500; opacity: 0.9; }
                
                svg { width: 100%; height: auto; display: block; overflow: visible; }
                
                /* --- SVG 元件樣式 --- */
                .step-bg { fill: white; stroke: <%= @theme_color %>; stroke-width: 2.5; }
                .step-title { font-size: 16px; font-weight: 700; fill: #334155; text-anchor: middle; }
                .step-desc { font-size: 12px; fill: #64748b; text-anchor: middle; }
                
                .number-circle { fill: <%= @theme_color %>; }
                .number-text { fill: white; font-size: 16px; font-weight: 700; text-anchor: middle; dominant-baseline: central; }
                
                .arrow-line { stroke: #cbd5e1; stroke-width: 2; fill: none; stroke-dasharray: 4,3; marker-end: url(#arrowhead); }
                
                .badge-bg { fill: <%= @theme_color %>; fill-opacity: 1; stroke: white; stroke-width: 2; rx: 12; }
                .badge-text { font-size: 11px; fill: white; font-weight: bold; text-anchor: middle; dominant-baseline: central; letter-spacing: 0.05em; }
            </style>
        </head>
        <body>
            <div class="paper-sheet">
                <h1><%= @title %></h1>
                <p class="subtitle"><%= @subtitle %></p>

                <svg viewBox="0 0 700 <%= @svg_height %>">
                    <defs>
                        <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                            <polygon points="0 0, 10 3.5, 0 7" fill="#cbd5e1" />
                        </marker>
                    </defs>

                    <!-- 連接線 -->
                    <% @steps.each_with_index do |_, index| %>
                      <% next if index == @steps.count - 1 %>
                      <% line_start_y = @start_y + (index * @step_height) + 80 %>
                      <path d="M 350 <%= line_start_y %> L 350 <%= line_start_y + 40 %>" class="arrow-line" />
                    <% end %>

                    <!-- 步驟群組 -->
                    <% @steps.each_with_index do |step, index| %>
                      <% current_y = @start_y + (index * @step_height) %>
                      <g transform="translate(150, <%= current_y %>)">
                          <rect x="0" y="0" width="400" height="80" rx="15" class="step-bg" />
                          <circle cx="0" cy="40" r="25" class="number-circle" />
                          <text x="0" y="40" class="number-text"><%= index + 1 %></text>
                          <text x="200" y="35" class="step-title"><%= step[:title] %></text>
                          <text x="200" y="55" class="step-desc"><%= step[:desc] %></text>
                          
                          <% if step[:badge] && !step[:badge].empty? %>
                            <rect x="315" y="-12" width="100" height="24" class="badge-bg" />
                            <text x="365" y="1" class="badge-text"><%= step[:badge] %></text>
                          <% end %>
                      </g>
                    <% end %>
                    
                    <text x="350" y="<%= @svg_height - 10 %>" text-anchor="middle" font-size="11" fill="#94a3b8" letter-spacing="1px">AUTOMATED ESG PIPELINE</text>
                </svg>
            </div>
        </body>
        </html>
      HTML
    end
  end
end

# -------------------------------------------------------------
# 專屬配置：永續報告書處理 Pipeline
# -------------------------------------------------------------

esg_pipeline_steps = [
  { 
    title: "每日入口 (Daily Trigger)", 
    desc: "掃描 00_inbox_raw 偵測新 PDF (run_daily.cmd)", 
    badge: "Automation" 
  },
  { 
    title: "預處理與歸檔 (Preprocessing)", 
    desc: "標準化命名並分流至 01_raw_keep 與 10_renamed", 
    badge: "Versioning" 
  },
  { 
    title: "文本轉換 (Text Conversion)", 
    desc: "批次轉換 PDF 為 TXT 至 20_text (extract_batch.py)", 
    badge: "Data Base" 
  },
  { 
    title: "核心指標抽取 (Metric Extraction)", 
    desc: "基於 Rules 與 Registry 掃描並正規化數據", 
    badge: "The Core" 
  },
  { 
    title: "結構化輸出 (Standardized Output)", 
    desc: "產出 metrics_batch_latest.csv 含 Evidence 來源行", 
    badge: "Traceability" 
  }
]

# 產生圖表
# 使用 "Emerald Green" (#059669) 作為代表永續/ESG 的主題色
generator = SvgFlow::Generator.new(
  title: "可擴充之永續報告書自動化抽取系統",
  subtitle: "Scalable SR Processing & Metric Extraction Workflow",
  steps: esg_pipeline_steps,
  theme_color: "#059669"
)

File.write("esg_workflow.html", generator.render)
puts "流程圖已生成: esg_workflow.html"
