import React, { useState } from 'react';
import { PieChart, Pie, Cell, BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } from 'recharts';
import { FileText, Truck, Factory, Zap, CheckCircle, Info, Scale } from 'lucide-react';

const Card = ({ children, className = "" }) => (
  <div className={`bg-white rounded-xl shadow-sm border border-slate-200 p-6 ${className}`}>
    {children}
  </div>
);

// --- 模擬係數與計算邏輯 ---

// 假設排放係數 (kgCO2e per unit) - 參考台灣常見數據或國際通用數據
const FACTORS = {
  electricity: 0.495, // kgCO2e/kWh (台電 2022/23 平均)
  pp: 1.95,           // kgCO2e/kg (泛用塑膠原料)
  masterbatch: 3.0,   // kgCO2e/kg (假設值，通常高於原料)
  diesel_truck: 0.11, // kgCO2e/ton-km (重型貨車)
  diesel_small: 0.20, // kgCO2e/ton-km (小型貨車)
  ship: 0.016,        // kgCO2e/ton-km (國際海運)
  gasoline: 2.26,     // kgCO2e/L
  diesel_fuel: 2.61,  // kgCO2e/L
  water: 0.156,       // kgCO2e/m3
  waste_incineration: 1.2, // kgCO2e/kg (一般廢棄物焚化)
  pp_incineration: 2.5,    // kgCO2e/kg (塑膠廢棄物焚化，含碳量高)
  hfc_227ea: 3220,    // GWP 值
};

// 原始活動數據 (來自 CSV)
const DATA = {
  electricity: 600000,
  pp: 500000,
  pp_dist: 200,
  masterbatch: 30000,
  mb_dist: 100,
  output_qty: 2120000,
  unit_weight: 0.25, // kg
  port_dist: 150,
  ship_dist: 3000,
  car_gasoline: 20000,
  water: 100000,
  factory_waste: 2000,
  waste_dist: 50,
  gen_diesel: 10,
  hfc: 20,
};

// 顏色調色盤 (低對比、柔和)
const COLORS = {
  material: '#94a3b8', // Slate 400
  energy: '#fca5a5',   // Red 300
  transport: '#93c5fd', // Blue 300
  waste: '#86efac',    // Green 300
  other: '#fdba74',    // Orange 300
};

const Report = () => {
  const [activeTab, setActiveTab] = useState('no_alloc');

  // --- 計算邏輯 ---

  // 1. 原物料階段 (Raw Materials) - 專屬於此產品
  const mat_pp = DATA.pp * FACTORS.pp;
  const mat_pp_trans = (DATA.pp / 1000) * DATA.pp_dist * FACTORS.diesel_truck;
  const mat_mb = DATA.masterbatch * FACTORS.masterbatch;
  const mat_mb_trans = (DATA.masterbatch / 1000) * DATA.mb_dist * FACTORS.diesel_small;
  const total_material = mat_pp + mat_pp_trans + mat_mb + mat_mb_trans;

  // 2. 製造/工廠階段 (Manufacturing) - 公共設施 (需討論分配)
  const mfg_elec = DATA.electricity * FACTORS.electricity;
  const mfg_water = DATA.water * FACTORS.water;
  const mfg_gasoline = DATA.car_gasoline * FACTORS.gasoline; // 公務車歸類於公司營運/製造支援
  const mfg_diesel = DATA.gen_diesel * FACTORS.diesel_fuel;
  const mfg_hfc = DATA.hfc * FACTORS.hfc_227ea;
  const mfg_waste = (DATA.factory_waste * FACTORS.waste_incineration) + 
                    ((DATA.factory_waste / 1000) * DATA.waste_dist * FACTORS.diesel_truck);
  
  const total_mfg_overhead = mfg_elec + mfg_water + mfg_gasoline + mfg_diesel + mfg_hfc + mfg_waste;

  // 3. 配送銷售階段 (Distribution) - 專屬於此產品
  const total_weight_ton = (DATA.output_qty * DATA.unit_weight) / 1000; // 530 tons
  const dist_land = total_weight_ton * DATA.port_dist * FACTORS.diesel_truck;
  const dist_sea = total_weight_ton * DATA.ship_dist * FACTORS.ship;
  const total_dist = dist_land + dist_sea;

  // 4. 廢棄處置 (End of Life) - 產品廢棄 (30% 焚化)
  // 題目：30% 焚化，70% 回收(不考量)。只計算 30% 的負擔。
  const eol_mass = (DATA.output_qty * DATA.unit_weight) * 0.3;
  const total_eol = eol_mass * FACTORS.pp_incineration; // 假設 PP 燃燒

  // --- 分配計算 (Allocation) ---
  // 目標產品：2,120,000 個 * 0.25 kg = 530,000 kg
  // 其他產品：4,240,000 個 * 0.50 kg = 2,120,000 kg
  // 總重量：2,650,000 kg
  // 分配率 (Allocation Ratio) = 530,000 / 2,650,000 = 0.2 (20%)
  const alloc_ratio = 0.2;

  // 情境 1: 無分配 (工廠費用全包)
  const result_no_alloc = {
    material: total_material,
    manufacturing: total_mfg_overhead, // 100%
    distribution: total_dist,
    eol: total_eol,
    total: total_material + total_mfg_overhead + total_dist + total_eol,
  };

  // 情境 2: 重量分配 (工廠費用打 2 折)
  const result_alloc = {
    material: total_material, // 專用，不分配
    manufacturing: total_mfg_overhead * alloc_ratio, // 分配 20%
    distribution: total_dist, // 專用
    eol: total_eol, // 專用
    total: total_material + (total_mfg_overhead * alloc_ratio) + total_dist + total_eol,
  };

  // 單位碳足跡
  const per_unit_no_alloc = result_no_alloc.total / DATA.output_qty;
  const per_unit_alloc = result_alloc.total / DATA.output_qty;

  // 圖表數據準備
  const pieDataNoAlloc = [
    { name: '原料取得 (Material)', value: result_no_alloc.material, color: COLORS.material },
    { name: '製造生產 (Manufacturing)', value: result_no_alloc.manufacturing, color: COLORS.energy },
    { name: '配送銷售 (Distribution)', value: result_no_alloc.distribution, color: COLORS.transport },
    { name: '廢棄處置 (End of Life)', value: result_no_alloc.eol, color: COLORS.waste },
  ];

  const pieDataAlloc = [
    { name: '原料取得 (Material)', value: result_alloc.material, color: COLORS.material },
    { name: '製造生產 (Manufacturing)', value: result_alloc.manufacturing, color: COLORS.energy },
    { name: '配送銷售 (Distribution)', value: result_alloc.distribution, color: COLORS.transport },
    { name: '廢棄處置 (End of Life)', value: result_alloc.eol, color: COLORS.waste },
  ];

  const compareData = [
    { name: '無分配 (No Allocation)', emissions: per_unit_no_alloc.toFixed(3) },
    { name: '重量分配 (Mass Allocation)', emissions: per_unit_alloc.toFixed(3) },
  ];

  return (
    <div className="min-h-screen bg-slate-50 p-6 font-sans text-slate-700">
      
      {/* Header */}
      <header className="mb-8">
        <h1 className="text-2xl font-bold text-slate-800 flex items-center gap-2">
          <Factory className="w-6 h-6 text-slate-500" />
          2023年度產品碳足跡盤查報告
        </h1>
        <p className="text-slate-500 mt-2">
          產品名稱：包裝盒 (PP) | 功能單位：1 個 (250g) | 產量：2,120,000 個
        </p>
      </header>

      {/* Navigation */}
      <div className="flex gap-4 mb-6 border-b border-slate-200">
        <button
          onClick={() => setActiveTab('no_alloc')}
          className={`pb-3 px-4 font-medium transition-colors ${activeTab === 'no_alloc' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-slate-400 hover:text-slate-600'}`}
        >
          報告一：無分配計算
        </button>
        <button
          onClick={() => setActiveTab('alloc')}
          className={`pb-3 px-4 font-medium transition-colors ${activeTab === 'alloc' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-slate-400 hover:text-slate-600'}`}
        >
          報告二：有分配計算
        </button>
        <button
          onClick={() => setActiveTab('compare')}
          className={`pb-3 px-4 font-medium transition-colors ${activeTab === 'compare' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-slate-400 hover:text-slate-600'}`}
        >
          結論與比較
        </button>
      </div>

      {/* Content Area */}
      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        {/* Main Chart/Data Panel */}
        <div className="lg:col-span-2 space-y-6">
          
          {activeTab === 'no_alloc' && (
            <div className="space-y-6 animate-in fade-in duration-500">
              <Card>
                <h3 className="text-lg font-semibold mb-4 text-slate-800 flex items-center gap-2">
                  <FileText className="w-5 h-5 text-slate-400" />
                  情境說明：無分配 (100% 歸屬)
                </h3>
                <p className="text-sm text-slate-600 mb-6 leading-relaxed">
                  此情境假設工廠內所有的能源消耗（電力、公務車汽油、發電機柴油）、水資源使用及滅火器逸散，完全是為了生產本批「包裝盒」而產生。這雖然可能高估了單一產品的排放，但能呈現工廠整體的營運碳風險。
                </p>
                <div className="h-80 w-full">
                  <ResponsiveContainer width="100%" height="100%">
                    <PieChart>
                      <Pie
                        data={pieDataNoAlloc}
                        cx="50%"
                        cy="50%"
                        innerRadius={60}
                        outerRadius={100}
                        paddingAngle={5}
                        dataKey="value"
                      >
                        {pieDataNoAlloc.map((entry, index) => (
                          <Cell key={`cell-${index}`} fill={entry.color} stroke="none" />
                        ))}
                      </Pie>
                      <Tooltip formatter={(value) => `${Math.round(value).toLocaleString()} kgCO2e`} contentStyle={{backgroundColor: '#fff', borderRadius: '8px', border: 'none', boxShadow: '0 2px 8px rgba(0,0,0,0.1)'}} />
                      <Legend verticalAlign="bottom" height={36} iconType="circle" />
                    </PieChart>
                  </ResponsiveContainer>
                </div>
              </Card>

              <div className="grid grid-cols-2 gap-4">
                <Card className="bg-blue-50/50 border-blue-100">
                  <div className="text-sm text-slate-500 mb-1">總排放量 (Total)</div>
                  <div className="text-2xl font-bold text-slate-700">{(result_no_alloc.total / 1000).toLocaleString(undefined, {maximumFractionDigits: 1})} <span className="text-base font-normal text-slate-500">公噸 CO2e</span></div>
                </Card>
                <Card className="bg-indigo-50/50 border-indigo-100">
                  <div className="text-sm text-slate-500 mb-1">每功能單位 (Per Unit)</div>
                  <div className="text-3xl font-bold text-blue-600">{per_unit_no_alloc.toFixed(3)} <span className="text-base font-normal text-slate-500">kg CO2e</span></div>
                </Card>
              </div>
            </div>
          )}

          {activeTab === 'alloc' && (
            <div className="space-y-6 animate-in fade-in duration-500">
               <Card>
                <h3 className="text-lg font-semibold mb-4 text-slate-800 flex items-center gap-2">
                  <Scale className="w-5 h-5 text-slate-400" />
                  情境說明：重量分配 (Mass Allocation)
                </h3>
                <div className="bg-slate-100 p-4 rounded-lg mb-6 text-sm">
                  <p className="font-semibold mb-2">分配計算邏輯：</p>
                  <ul className="list-disc pl-5 space-y-1 text-slate-600">
                    <li>本產品總重：2,120,000 個 × 0.25 kg = 530,000 kg</li>
                    <li>其他產品總重：4,240,000 個 × 0.50 kg = 2,120,000 kg</li>
                    <li>工廠總產出重量：2,650,000 kg</li>
                    <li><strong>本產品分配比例：20%</strong></li>
                  </ul>
                  <p className="mt-2 text-slate-500 text-xs">* 原物料與產品配送因題目註明材質不同，故維持 100% 專用，僅公共設施（水、電、廢棄物、公務車等）進行 20% 分配。</p>
                </div>
                
                <div className="h-80 w-full">
                  <ResponsiveContainer width="100%" height="100%">
                    <PieChart>
                      <Pie
                        data={pieDataAlloc}
                        cx="50%"
                        cy="50%"
                        innerRadius={60}
                        outerRadius={100}
                        paddingAngle={5}
                        dataKey="value"
                      >
                        {pieDataAlloc.map((entry, index) => (
                          <Cell key={`cell-${index}`} fill={entry.color} stroke="none" />
                        ))}
                      </Pie>
                      <Tooltip formatter={(value) => `${Math.round(value).toLocaleString()} kgCO2e`} contentStyle={{backgroundColor: '#fff', borderRadius: '8px', border: 'none', boxShadow: '0 2px 8px rgba(0,0,0,0.1)'}} />
                      <Legend verticalAlign="bottom" height={36} iconType="circle" />
                    </PieChart>
                  </ResponsiveContainer>
                </div>
              </Card>

              <div className="grid grid-cols-2 gap-4">
                <Card className="bg-green-50/50 border-green-100">
                  <div className="text-sm text-slate-500 mb-1">總排放量 (Total)</div>
                  <div className="text-2xl font-bold text-slate-700">{(result_alloc.total / 1000).toLocaleString(undefined, {maximumFractionDigits: 1})} <span className="text-base font-normal text-slate-500">公噸 CO2e</span></div>
                </Card>
                <Card className="bg-emerald-50/50 border-emerald-100">
                  <div className="text-sm text-slate-500 mb-1">每功能單位 (Per Unit)</div>
                  <div className="text-3xl font-bold text-emerald-600">{per_unit_alloc.toFixed(3)} <span className="text-base font-normal text-slate-500">kg CO2e</span></div>
                </Card>
              </div>
            </div>
          )}

          {activeTab === 'compare' && (
            <div className="space-y-6 animate-in fade-in duration-500">
              <Card>
                <h3 className="text-lg font-semibold mb-6 text-slate-800">分配前後碳足跡比較</h3>
                <div className="h-80 w-full">
                  <ResponsiveContainer width="100%" height="100%">
                    <BarChart
                      data={compareData}
                      layout="vertical"
                      margin={{ top: 5, right: 30, left: 20, bottom: 5 }}
                    >
                      <CartesianGrid strokeDasharray="3 3" horizontal={false} stroke="#e2e8f0" />
                      <XAxis type="number" stroke="#94a3b8" fontSize={12} tickFormatter={(val) => `${val} kg`} />
                      <YAxis dataKey="name" type="category" width={150} stroke="#475569" fontSize={13} />
                      <Tooltip cursor={{fill: '#f1f5f9'}} contentStyle={{borderRadius: '8px', border: 'none', boxShadow: '0 4px 6px -1px rgba(0, 0, 0, 0.1)'}} />
                      <Bar dataKey="emissions" fill="#6366f1" radius={[0, 4, 4, 0]} barSize={40}>
                        {
                          compareData.map((entry, index) => (
                            <Cell key={`cell-${index}`} fill={index === 0 ? '#94a3b8' : '#10b981'} />
                          ))
                        }
                      </Bar>
                    </BarChart>
                  </ResponsiveContainer>
                </div>
              </Card>

              <Card className="bg-slate-800 text-slate-200">
                <h4 className="font-semibold text-white mb-2 flex items-center gap-2">
                  <CheckCircle className="w-5 h-5 text-emerald-400" />
                  綜合分析結論
                </h4>
                <ul className="space-y-3 text-sm leading-relaxed text-slate-300">
                  <li>
                    <strong className="text-white">顯著差異：</strong>
                    進行重量分配後，單一產品的碳足跡由 <strong>{per_unit_no_alloc.toFixed(2)}</strong> 降至 <strong>{per_unit_alloc.toFixed(2)} kgCO2e</strong>。
                    主要原因在於「製造生產階段 (Manufacturing)」的公共設施排放被合理分攤至工廠內的其他大量產品上（佔80%產量）。
                  </li>
                  <li>
                    <strong className="text-white">熱點分析：</strong>
                    無論是否分配，<span className="text-slate-100 border-b border-slate-500">原料取得 (Raw Material)</span> 皆為最大碳排放熱點（PP 原料與色母），佔比極高。這顯示若要進一步減碳，應優先考量使用再生料 (PCR) 或低碳塑料。
                  </li>
                  <li>
                    <strong className="text-white">廢棄物處理：</strong>
                    雖然 30% 的焚化處理僅佔一小部分，但在塑膠產品中，廢棄燃燒的碳排係數較高，仍是不可忽視的環節。
                  </li>
                </ul>
              </Card>
            </div>
          )}
        </div>

        {/* Sidebar / Detailed Stats */}
        <div className="space-y-6">
          <Card>
            <h3 className="text-sm font-bold text-slate-400 uppercase tracking-wider mb-4">排放熱點細項 (kgCO2e)</h3>
            <div className="space-y-4">
              
              {/* Item */}
              <div>
                <div className="flex justify-between text-sm mb-1">
                  <span className="flex items-center gap-2 text-slate-600"><Factory className="w-4 h-4" /> 製造階段 (Mfg)</span>
                  <span className="font-semibold text-slate-700">
                    {activeTab === 'alloc' 
                      ? Math.round(result_alloc.manufacturing).toLocaleString() 
                      : Math.round(result_no_alloc.manufacturing).toLocaleString()}
                  </span>
                </div>
                <div className="w-full bg-slate-100 rounded-full h-1.5">
                  <div 
                    className="bg-red-300 h-1.5 rounded-full transition-all duration-500" 
                    style={{ width: `${((activeTab === 'alloc' ? result_alloc.manufacturing : result_no_alloc.manufacturing) / (activeTab === 'alloc' ? result_alloc.total : result_no_alloc.total)) * 100}%` }}
                  ></div>
                </div>
              </div>

              {/* Item */}
              <div>
                <div className="flex justify-between text-sm mb-1">
                  <span className="flex items-center gap-2 text-slate-600"><Zap className="w-4 h-4" /> 原料取得 (Mat)</span>
                  <span className="font-semibold text-slate-700">{Math.round(total_material).toLocaleString()}</span>
                </div>
                <div className="w-full bg-slate-100 rounded-full h-1.5">
                  <div 
                    className="bg-slate-400 h-1.5 rounded-full transition-all duration-500" 
                    style={{ width: `${(total_material / (activeTab === 'alloc' ? result_alloc.total : result_no_alloc.total)) * 100}%` }}
                  ></div>
                </div>
              </div>

               {/* Item */}
               <div>
                <div className="flex justify-between text-sm mb-1">
                  <span className="flex items-center gap-2 text-slate-600"><Truck className="w-4 h-4" /> 配送銷售 (Dist)</span>
                  <span className="font-semibold text-slate-700">{Math.round(total_dist).toLocaleString()}</span>
                </div>
                <div className="w-full bg-slate-100 rounded-full h-1.5">
                  <div 
                    className="bg-blue-300 h-1.5 rounded-full transition-all duration-500" 
                    style={{ width: `${(total_dist / (activeTab === 'alloc' ? result_alloc.total : result_no_alloc.total)) * 100}%` }}
                  ></div>
                </div>
              </div>

            </div>
            
            <div className="mt-6 pt-6 border-t border-slate-100 text-xs text-slate-400 space-y-2">
              <p className="flex gap-2 items-start">
                <Info className="w-3 h-3 mt-0.5 flex-shrink-0" />
                <span>數據來源：2023年度產品生產相關活動數據表</span>
              </p>
              <p>係數：採用台灣電力係數 0.495、PP 1.95、HFC GWP 3220 等通用數據模擬。</p>
            </div>
          </Card>
        </div>

      </div>
    </div>
  );
};

export default Report;
